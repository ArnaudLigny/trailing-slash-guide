<html>
<body>
<script type="module">
  import {markdownTable} from "https://cdn.skypack.dev/markdown-table@3.0.0";

  // For GH pages, absolute urls like /file won't work as GH deployments have a base url
  // Ex https://slorber.github.io/trailing-slash-guide/
  // We must use "file" or "/trailing-slash-guide/file"
  // Using a relative url like "file" is more convenient/portable
  function toRelativeUrl(url) {
    return url.substring(1);
  }

  async function fetchUrl(url) {
    // Using {redirect: "manual"} is not a good solution => shows status=0 + redirect url is not accessible
    const response = await fetch(toRelativeUrl(url));
    console.log({url, response});
    return {
      url,
      status: response.status, // Note: fetch follows redirects and output status=200
      redirectUrl: response.redirected ? new URL(response.url).pathname : undefined
    };
  }

  function formatResult(result) {
    return result.status !== 200 ?
      `💢 ${result.status}`
      : result.redirectUrl ?
        `➡️ ${result.redirectUrl}`
        : '✅'
  }

  function addUrlResultToDOM(result) {
    const div = document.createElement("div");
    const a = document.createElement('a');
    a.appendChild(document.createTextNode(result.url));
    a.href = toRelativeUrl(result.url);

    div.appendChild(a);
    div.appendChild(document.createTextNode(" - "));
    div.appendChild(document.createTextNode(formatResult(result)));

    document.body.appendChild(div);
  }

  function printMarkdownTable(results) {
    const markdownTableString = markdownTable([
      ['Url', 'Result'],
      ...results.map(result => [result.url, formatResult(result)])
    ]);
    console.log("markdownTableString:");
    console.log(markdownTableString);
  }

  async function run() {
    const Urls = [
      "/file",
      "/file/",
      "/folder",
      "/folder/",
      "/both",
      "/both/",
    ];
    const results = await Promise.all(Urls.map(fetchUrl))

    results.forEach(addUrlResultToDOM);

    printMarkdownTable(results);
  }

  run().catch(e => {
    console.error(e);
    alert("Error, check the console: " + e.message);
  });

</script>
</body>
</html>
